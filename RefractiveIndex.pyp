#  ==============================================
#                   Import
# ==============================================
# localimport-v1.5_b64_lw=99
if bool(1):
    exec("""import base64 as b, zlib as z; s={}; blob=b"\
    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";exec(z.decompress(b.b64decode(blob)), s);localimport=s["localimport"]; del blob, b, z, s;""")

import c4d
import os

with localimport('.') as _importer:
    from res.src.Const import  Const
    from res.src.MiscFunction import MiscFunction
    from res.src.JsonFunction import JsonFunction
    from res.src.UserData import UD
    from res.src.Ui import Ui

# ==============================================
#                   Import
# ==============================================

__author__ = 'Adam Maxime - Graphos <gr4ph0s(at)hotmail.fr>'
__project__ = "https://github.com/gr4ph0s/RefractiveIndex-Importer"
__version__ = '1.1'

class lunchTag(c4d.plugins.TagData):
    """
    Main class representing our tag.
    """
    def Init(self, node):
        """ Init method for a TagData"""
        self.dataSpline = [None]*3
        self.dataGradient = [None]*4
        self.toInit = True

        self.miscFunction = MiscFunction()
        self.jsonFunction = JsonFunction()
        self.ud = UD(node)
        self.ui = Ui()

        self.jsonFunction.load_json_file()

        return True

    def create_curve_tab(self):
        """
        Create the main section of the tag UI, Where we get our RGB spline
        """
        #Create the tab
        self.ud.create_group(Const.UI_GROUP_CURVE,"Curve",c4d.DescID())

        #Create metal selection section
        self.ud.create_group(Const.UI_GROUP_CURVE_METAL_TYPE,"Metal Type",self.ud.idGroups[Const.UI_GROUP_CURVE],3,None,False)
        self.ud.create_cycle(Const.UI_CYCLE,self.jsonFunction.get_all_name(),self.ud.idGroups[Const.UI_GROUP_CURVE_METAL_TYPE],"Metal Type")
        self.ud.create_button(Const.UI_BUTTON_REFRESH,self.ud.idGroups[Const.UI_GROUP_CURVE_METAL_TYPE],"Refresh")
        self.ud.create_button(Const.UI_BUTTON_DELETE,self.ud.idGroups[Const.UI_GROUP_CURVE_METAL_TYPE],"Delete")

        #Put in memory the spline data acording the Preset
        self.ui.set_spline_data(self, 4, True)
        self.ui.set_gradient_data(self, 4, True)

        #Create Red section
        self.ud.create_group(Const.UI_GROUP_CURVE_RED,"Red",self.ud.idGroups[Const.UI_GROUP_CURVE])
        self.ud.create_int_slider(Const.UI_SLIDER_RED,50,self.ud.idGroups[Const.UI_GROUP_CURVE_RED],"Precision")
        self.ud.create_bool(Const.UI_BOOL_RED_X,False,self.ud.idGroups[Const.UI_GROUP_CURVE_RED],"Invert X")
        self.ud.create_bool(Const.UI_BOOL_RED_Y,False,self.ud.idGroups[Const.UI_GROUP_CURVE_RED],"Invert Y")
        self.ud.create_spline(Const.UI_SPLINE_RED,self.dataSpline[0],self.ud.idGroups[Const.UI_GROUP_CURVE_RED],"Red")
        self.ud.create_gradient(Const.UI_GRADIENT_RED,self.dataGradient[0],self.ud.idGroups[Const.UI_GROUP_CURVE_RED],"Red")

        #Create Green section
        self.ud.create_group(Const.UI_GROUP_CURVE_GREEN,"Green",self.ud.idGroups[Const.UI_GROUP_CURVE])
        self.ud.create_int_slider(Const.UI_SLIDER_GREEN,50,self.ud.idGroups[Const.UI_GROUP_CURVE_GREEN],"Precision")
        self.ud.create_bool(Const.UI_BOOL_GREEN_X,False,self.ud.idGroups[Const.UI_GROUP_CURVE_GREEN],"Invert X")
        self.ud.create_bool(Const.UI_BOOL_GREEN_Y,False,self.ud.idGroups[Const.UI_GROUP_CURVE_GREEN],"Invert Y")
        self.ud.create_spline(Const.UI_SPLINE_GREEN,self.dataSpline[1],self.ud.idGroups[Const.UI_GROUP_CURVE_GREEN],"Green")
        self.ud.create_gradient(Const.UI_GRADIENT_GREEN,self.dataGradient[1],self.ud.idGroups[Const.UI_GROUP_CURVE_GREEN],"Green")

        #Create Blue section
        self.ud.create_group(Const.UI_GROUP_CURVE_BLUE,"Blue",self.ud.idGroups[Const.UI_GROUP_CURVE])
        self.ud.create_int_slider(Const.UI_SLIDER_BLUE,50,self.ud.idGroups[Const.UI_GROUP_CURVE_BLUE],"Precision")
        self.ud.create_bool(Const.UI_BOOL_BLUE_X,False,self.ud.idGroups[Const.UI_GROUP_CURVE_BLUE],"Invert X")
        self.ud.create_bool(Const.UI_BOOL_BLUE_Y,False,self.ud.idGroups[Const.UI_GROUP_CURVE_BLUE],"Invert Y")
        self.ud.create_spline(Const.UI_SPLINE_BLUE,self.dataSpline[2],self.ud.idGroups[Const.UI_GROUP_CURVE_BLUE],"Blue")
        self.ud.create_gradient(Const.UI_GRADIENT_BLUE,self.dataGradient[2],self.ud.idGroups[Const.UI_GROUP_CURVE_BLUE],"Blue")

        #Create RGB section
        self.ud.create_group(Const.UI_GROUP_RGB,"RGB",self.ud.idGroups[Const.UI_GROUP_CURVE])
        self.ud.create_int_slider(Const.UI_SLIDER_RGB,50,self.ud.idGroups[Const.UI_GROUP_RGB],"Precision")
        self.ud.create_gradient(Const.UI_GRADIENT_RGB,self.dataGradient[3],self.ud.idGroups[Const.UI_GROUP_RGB],"RGB")

    def create_create_tab(self):
        """
        Create the section where we can create new preset
        :return:
        """
        #Create the Create tab
        self.ud.create_group(Const.UI_GROUP_CREATE,"Create",c4d.DescID())

        #Create inpufield for Preset name
        self.ud.create_string_input(Const.UI_STR_MAT_NAME,"Material Name",self.ud.idGroups[Const.UI_GROUP_CREATE],"Material Name")

        #Create Red section
        self.ud.create_separator(Const.UI_SEPARATOR_RED,self.ud.idGroups[Const.UI_GROUP_CREATE],"Red | Value [0.62 => 0.74] ~= 0.68")
        self.ud.create_string_input(Const.UI_STR_RED_N,str(0.0001),self.ud.idGroups[Const.UI_GROUP_CREATE], "n")
        self.ud.create_string_input(Const.UI_STR_RED_K,str(0.0001),self.ud.idGroups[Const.UI_GROUP_CREATE], "k")

        #Create Green section
        self.ud.create_separator(Const.UI_SEPARATOR_GREEN,self.ud.idGroups[Const.UI_GROUP_CREATE],"Green | Value [0.495 => 0.570] ~= 0.5325")
        self.ud.create_string_input(Const.UI_STR_GREEN_N,str(0.0001),self.ud.idGroups[Const.UI_GROUP_CREATE], "n")
        self.ud.create_string_input(Const.UI_STR_GREEN_K,str(0.0001),self.ud.idGroups[Const.UI_GROUP_CREATE], "k")

        #Create Blue section
        self.ud.create_separator(Const.UI_SEPARATOR_BLUE,self.ud.idGroups[Const.UI_GROUP_CREATE],"Blue | Value [0.450 => 0.495] ~= 0.4725")
        self.ud.create_string_input(Const.UI_STR_BLUE_N,str(0.0001),self.ud.idGroups[Const.UI_GROUP_CREATE], "n")
        self.ud.create_string_input(Const.UI_STR_BLUE_K,str(0.0001),self.ud.idGroups[Const.UI_GROUP_CREATE], "k")

        #Create button for save change
        self.ud.create_button(Const.UI_BUTTON_CREATE,self.ud.idGroups[Const.UI_GROUP_CREATE],"Create")

    def Message(self, node, type, data):
        """
        Message Method overide method for get all message from c4d
        """

        #If we build menu
        if type == c4d.MSG_MENUPREPARE:
            self.create_curve_tab()
            self.create_create_tab()
            self.ud.create_bc_from_id()
            self.ud.set_old_value()
            self.toInit = False

        #If we have build or menu but not init our data
        if self.toInit:
            if self.ud.idCycle[0] is None:
                self.toInit = False
                self.ud.populate_id_from_bc()
                self.ud.set_old_value()
                if not self.jsonFunction.metal_exist(self.ud.get_current_cycle_text(Const.UI_CYCLE)):
                    self.ui.refresh_cycle(self, True)

        #If we change any data object data (like spline data)
        if type == c4d.MSG_DESCRIPTION_CHECKUPDATE:
            currentNbPts, currentInv, currentCycle = self.ud.get_current_data()

            if self.ud.oldNbPoints != currentNbPts:
                diffs = self.miscFunction.get_diff(self.ud.oldNbPoints, currentNbPts)
                for diff in diffs:
                    if diff < 3:
                        self.ui.set_spline_data(self, diff)
                        self.ud.create_spline(diff, self.dataSpline[diff])

                self.ud.oldNbPoints = currentNbPts
                

            if self.ud.oldInvert != currentInv:
                diffs = self.miscFunction.get_diff(self.ud.oldInvert, currentInv)
                for diff in diffs:
                    if diff >= 3:
                        y = diff - 3
                    else:
                        y = diff

                    self.ui.set_spline_data(self, y)
                    self.ud.create_spline(y, self.dataSpline[y])

                self.ud.oldInvert = currentInv

            if self.ud.oldCycle != currentCycle:
                self.ui.refresh_cycle(self, True)
                self.ud.oldCycle = currentCycle

            for i in xrange(3):
                self.dataSpline[i] = node[self.ud.idSplines[i]]

            for i in xrange(4):
                self.ui.set_gradient_data(self, i)
                self.ud.create_gradient(i, self.dataGradient[i])

        #If we press a button
        if type == c4d.MSG_DESCRIPTION_COMMAND:
            if data.has_key('id'):
                if(data['id'][0].id == 700):

                    #Refresh Button
                    if data['id'] == self.ud.idButtons[Const.UI_BUTTON_REFRESH]:
                        self.ui.refresh_preset(self)

                    #Create Preset Button
                    elif data['id'] == self.ud.idButtons[Const.UI_BUTTON_CREATE]:
                        self.ui.create_preset(self)

                    #Delete Preset Button
                    elif data['id'] == self.ud.idButtons[Const.UI_BUTTON_DELETE]:
                        self.ui.delete_preset(self)

        return True

    def Execute(self, tag, doc, op, bt, priority, flags):
        return c4d.EXECUTIONRESULT_OK

if __name__ == "__main__":

    dir, file = os.path.split(__file__)
    bmp = c4d.bitmaps.BaseBitmap()
    bmp.InitWith(os.path.join(dir, "res", "RefractiveIndex.png"))
    c4d.plugins.RegisterTagPlugin(id=Const.PLUGIN_ID,
                                str='Refractive-Index v{}'.format(Const.VERSION),
                                g=lunchTag,
                                description="TREFLECTION_INDEX", 
                                icon=bmp,
                                info=c4d.TAG_EXPRESSION|c4d.TAG_VISIBLE|c4d.TAG_MULTIPLE)
